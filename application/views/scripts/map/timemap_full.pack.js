/* 
 * TimeMap Copyright 2008 Nick Rabinowitz.
 * Licensed under the MIT License (see LICENSE.txt)
 */
var DT=Timeline.DateTime,GIP="http://www.google.com/intl/en_us/mapfiles/ms/icons/";function TimeMap(e,h,m){this.mElement=h;this.tElement=e;this.datasets={};this.filters={};this.mapBounds=new GLatLngBounds();this.opts=m||{};if(typeof(m.mapType)=="string"){m.mapType=TimeMap.mapTypes[m.mapType]}if(typeof(m.mapFilter)=="string"){m.mapFilter=TimeMap.filters[m.mapFilter]}var k=m.mapCenter||new GLatLng(0,0),j=m.mapZoom||0,b=m.mapType||G_PHYSICAL_MAP,l=m.mapTypes||[G_NORMAL_MAP,G_SATELLITE_MAP,G_PHYSICAL_MAP],c=("showMapTypeCtrl" in m)?m.showMapTypeCtrl:true,g=("showMapCtrl" in m)?m.showMapCtrl:true;this.opts.syncBands=("syncBands" in m)?m.syncBands:true;this.opts.mapFilter=m.mapFilter||TimeMap.filters.hidePastFuture;this.opts.centerOnItems=("centerMapOnItems" in m)?m.centerMapOnItems:true;if(GBrowserIsCompatible()){var a=this.map=new GMap2(this.mElement);if(g){a.addControl(new GLargeMapControl())}if(c){a.addControl(new GMapTypeControl())}var f;for(f=G_DEFAULT_MAP_TYPES.length-1;f>0;f--){a.removeMapType(G_DEFAULT_MAP_TYPES[f])}a.addMapType(l[0]);a.removeMapType(G_DEFAULT_MAP_TYPES[0]);for(f=1;f<l.length;f++){a.addMapType(l[f])}a.enableDoubleClickZoom();a.enableScrollWheelZoom();a.enableContinuousZoom();a.setCenter(k,j);a.setMapType(b)}}TimeMap.version="1.5pre";TimeMap.init=function(c){if(!("mapId" in c)||!c.mapId){throw"TimeMap.init: No id for map"}if(!("timelineId" in c)||!c.timelineId){throw"TimeMap.init: No id for timeline"}c=c||{};c.options=c.options||{};c.datasets=c.datasets||[];c.bandInfo=c.bandInfo||false;c.scrollTo=c.scrollTo||"earliest";if(!c.bandInfo&&!c.bands){var j=c.bandIntervals||c.options.bandIntervals||[DT.WEEK,DT.MONTH];if(typeof(j)=="string"){j=TimeMap.intervals[j]}c.options.bandIntervals=j;c.bandInfo=[{width:"80%",intervalUnit:j[0],intervalPixels:70},{width:"20%",intervalUnit:j[1],intervalPixels:100,showEventText:false,overview:true,trackHeight:0.4,trackGap:0.2}]}var m=new TimeMap(document.getElementById(c.timelineId),document.getElementById(c.mapId),c.options);var h=[],l,b,f,a;for(l=0;l<c.datasets.length;l++){b=c.datasets[l];f=b.options||{};f.title=b.title||"";f.theme=b.theme;f.dateParser=b.dateParser;a=b.id||"ds"+l;h[l]=m.createDataset(a,f);if(l>0){h[l].eventSource=h[0].eventSource}}m.eventSource=h[0].eventSource;var g=[];var e=(h[0]&&h[0].eventSource)||new Timeline.DefaultEventSource();if(c.bands){g=c.bands;for(l=0;l<g.length;l++){if(g[l].eventSource!==null){g[l].eventSource=e}}}else{for(l=0;l<c.bandInfo.length;l++){var k=c.bandInfo[l];if(!(("eventSource" in k)&&!k.eventSource)){k.eventSource=e}else{k.eventSource=null}g[l]=Timeline.createBandInfo(k);if(l>0&&TimeMap.TimelineVersion()=="1.2"){g[l].eventPainter.setLayout(g[0].eventPainter.getLayout())}}}m.initTimeline(g);var i=TimeMap.loadManager;i.init(m,c.datasets.length,c);for(l=0;l<c.datasets.length;l++){(function(o){var s=c.datasets[o],p,r,t,q,n;p=s.options||s.data||{};r=s.type||p.type;t=function(){i.increment()};q=(typeof(r)=="string")?TimeMap.loaders[r]:r;n=new q(p);n.load(h[o],t)})(l)}return m};var timemapInit=TimeMap.init;TimeMap.loadManager=new function(){this.init=function(a,c,b){this.count=0;this.tm=a;this.target=c;this.opts=b||{}};this.increment=function(){this.count++;if(this.count>=this.target){this.complete()}};this.complete=function(){var b=this.opts.dataLoadedFunction;if(b){b(tm)}else{var e=new Date();var c=this.tm.eventSource;var a=this.opts.scrollTo;if(a&&c.getCount()>0){switch(a){case"now":break;case"earliest":e=c.getEarliestDate();break;case"latest":e=c.getLatestDate();break;default:if(typeof(a)=="string"){a=TimeMapDataset.hybridParser(a)}if(a.constructor==Date){e=a}}this.tm.timeline.getBand(0).setCenterVisibleDate(e)}this.tm.timeline.layout();b=this.opts.dataDisplayedFunction;if(b){b(tm)}}}};TimeMap.loaders={};TimeMap.loaders.basic=function(a){TimeMap.loaders.mixin(this,a);this.data=a.items||a.value||[]};TimeMap.loaders.basic.prototype.load=function(b,c){var a=this.preload(this.data);b.loadItems(a,this.transform);c()};TimeMap.loaders.remote=function(a){TimeMap.loaders.mixin(this,a);this.url=a.url};TimeMap.loaders.remote.prototype.load=function(b,c){var a=this;GDownloadUrl(this.url,function(e){var f=a.parse(e);f=a.preload(f);b.loadItems(f,a.transform);c()})};TimeMap.loaders.mixin=function(a,b){var c=function(e){return e};a.parse=b.parserFunction||c;a.preload=b.preloadFunction||c;a.transform=b.transformFunction||c};TimeMap.intervals={sec:[DT.SECOND,DT.MINUTE],min:[DT.MINUTE,DT.HOUR],hr:[DT.HOUR,DT.DAY],day:[DT.DAY,DT.WEEK],wk:[DT.WEEK,DT.MONTH],mon:[DT.MONTH,DT.YEAR],yr:[DT.YEAR,DT.DECADE],dec:[DT.DECADE,DT.CENTURY]};TimeMap.mapTypes={normal:G_NORMAL_MAP,satellite:G_SATELLITE_MAP,hybrid:G_HYBRID_MAP,physical:G_PHYSICAL_MAP,moon:G_MOON_VISIBLE_MAP,sky:G_SKY_VISIBLE_MAP};TimeMap.prototype.createDataset=function(e,b){b=b||{};if(!("title" in b)){b.title=e}var c=new TimeMapDataset(this,b);this.datasets[e]=c;if(this.opts.centerOnItems){var a=this;GEvent.addListener(c,"itemsloaded",function(){var g=a.map,f=a.mapBounds;g.setZoom(g.getBoundsZoomLevel(f));g.setCenter(f.getCenter())})}return c};TimeMap.prototype.each=function(a){for(var b in this.datasets){if(this.datasets.hasOwnProperty(b)){a(this.datasets[b])}}};TimeMap.prototype.initTimeline=function(f){for(var a=1;a<f.length;a++){if(this.opts.syncBands){f[a].syncWith=(a-1)}f[a].highlight=true}this.timeline=Timeline.create(this.tElement,f);var c=this;this.timeline.getBand(0).addOnScrollListener(function(){c.filter("map")});var b=this.timeline.getBand(0).getEventPainter().constructor;b.prototype._showBubble=function(h,j,i){i.item.openInfoWindow()};this.addFilterChain("map",function(h){h.showPlacemark()},function(h){h.hidePlacemark()});this.addFilter("map",function(h){return h.visible});this.addFilter("map",function(h){return h.dataset.visible});this.addFilter("map",this.opts.mapFilter);this.addFilterChain("timeline",function(h){h.showEvent()},function(h){h.hideEvent()});this.addFilter("timeline",function(h){return h.visible});this.addFilter("timeline",function(h){return h.dataset.visible});var g=null;var e=this.timeline;window.onresize=function(){if(g===null){g=window.setTimeout(function(){g=null;e.layout()},500)}}};TimeMap.prototype.filter=function(b){var a=this.filters[b];if(!a||!a.chain||a.chain.length===0){return}this.each(function(c){c.each(function(f){F_LOOP:{for(var e=a.chain.length-1;e>=0;e--){if(!a.chain[e](f)){a.off(f);break F_LOOP}}a.on(f)}})})};TimeMap.prototype.addFilterChain=function(c,b,a){this.filters[c]={chain:[],on:b,off:a}};TimeMap.prototype.removeFilterChain=function(c,a,b){this.filters[c]=null};TimeMap.prototype.addFilter=function(b,a){if(this.filters[b]&&this.filters[b].chain){this.filters[b].chain.push(a)}};TimeMap.prototype.removeFilter=function(a){if(this.filters[a]&&this.filters[a].chain){this.filters[a].chain.pop()}};TimeMap.filters={};TimeMap.filters.hidePastFuture=function(e){var g=e.dataset.timemap.timeline.getBand(0);var b=g.getMaxVisibleDate().getTime();var c=g.getMinVisibleDate().getTime();if(e.event!==null){var a=e.event.getStart().getTime();var f=e.event.getEnd().getTime();if(a>b){return false}else{if(f<c||(e.event.isInstant()&&a<c)){return false}}}return true};TimeMap.filters.showMomentOnly=function(b){var e=b.dataset.timemap.timeline.getBand(0);var f=e.getCenterVisibleDate().getTime();if(b.event!==null){var a=b.event.getStart().getTime();var c=b.event.getEnd().getTime();if(a>f){return false}else{if(c<f||(b.event.isInstant()&&a<f)){return false}}}return true};function TimeMapDataset(a,b){this.timemap=a;this.eventSource=new Timeline.DefaultEventSource();this.items=[];this.visible=true;this.opts=b||{};this.opts.title=b.title||"";if(typeof(b.theme)=="string"){b.theme=TimeMapDataset.themes[b.theme]}this.opts.theme=b.theme||this.timemap.opts.theme||new TimeMapDatasetTheme({});this.opts.theme.eventIconPath=b.eventIconPath||this.timemap.opts.eventIconPath||this.opts.theme.eventIconPath;this.opts.theme.eventIcon=b.eventIconPath+this.opts.theme.eventIconImage;if(typeof(b.dateParser)=="string"){b.dateParser=TimeMapDataset.dateParsers[b.dateParser]}this.opts.dateParser=b.dateParser||TimeMapDataset.hybridParser;this.getItems=function(){return this.items};this.getTitle=function(){return this.opts.title}}TimeMapDataset.gregorianParser=function(a){d=DT.parseGregorianDateTime(a);if(!d.getFullYear()){d=null}return d};TimeMapDataset.hybridParser=function(a){var b=DT.parseIso8601DateTime(a);if(!b){b=TimeMapDataset.gregorianParser(a)}return b};TimeMapDataset.dateParsers={hybrid:TimeMapDataset.hybridParser,iso8601:DT.parseIso8601DateTime,gregorian:TimeMapDataset.gregorianParser};TimeMapDataset.prototype.each=function(b){for(var a=0;a<this.items.length;a++){b(this.items[a])}};TimeMapDataset.prototype.loadItems=function(c,b){for(var a=0;a<c.length;a++){this.loadItem(c[a],b)}GEvent.trigger(this,"itemsloaded")};TimeMapDataset.prototype.loadItem=function(B,r){if(r!==undefined){B=r(B)}if(B===null){return}var j=B.options||{};if(typeof(j.theme)=="string"){j.theme=TimeMapDataset.themes[j.theme]}var A=j.theme||this.opts.theme;A.eventIconPath=j.eventIconPath||this.opts.theme.eventIconPath;A.eventIcon=A.eventIconPath+A.eventIconImage;var g=this.timemap;var f=this.opts.dateParser,m=B.start,k=B.end,e;m=(m===undefined||m==="")?null:f(m);k=(k===undefined||k==="")?null:f(k);e=(k===undefined);var c=A.eventIcon,C=B.title,w=null;if(m!==null){var o=Timeline.DefaultEventSource.Event;if(TimeMap.TimelineVersion()=="1.2"){w=new o(m,k,null,null,e,C,null,null,null,c,A.eventColor,A.eventTextColor)}else{var l=A.eventTextColor;if(!l){l=(A.classicTape&&!e)?"#FFFFFF":"#000000"}w=new o({start:m,end:k,instant:e,text:C,icon:c,color:A.eventColor,textColor:l})}}var a=("icon" in B)?B.icon:A.icon,n=g.mapBounds;var t=function(E){var D=null,F="",H=null;if("point" in E){H=new GLatLng(parseFloat(E.point.lat),parseFloat(E.point.lon));if(g.opts.centerOnItems){n.extend(H)}D=new GMarker(H,{icon:a});F="marker";H=D.getLatLng()}else{if("polyline" in E||"polygon" in E){var J=[],K;if("polyline" in E){K=E.polyline}else{K=E.polygon}for(var G=0;G<K.length;G++){H=new GLatLng(parseFloat(K[G].lat),parseFloat(K[G].lon));J.push(H);if(g.opts.centerOnItems){n.extend(H)}}if("polyline" in E){D=new GPolyline(J,A.lineColor,A.lineWeight,A.lineOpacity);F="polyline";H=D.getVertex(Math.floor(D.getVertexCount()/2))}else{D=new GPolygon(J,A.polygonLineColor,A.polygonLineWeight,A.polygonLineOpacity,A.fillColor,A.fillOpacity);F="polygon";H=D.getBounds().getCenter()}}else{if("overlay" in E){var I=new GLatLng(parseFloat(E.overlay.south),parseFloat(E.overlay.west));var p=new GLatLng(parseFloat(E.overlay.north),parseFloat(E.overlay.east));if(g.opts.centerOnItems){n.extend(I);n.extend(p)}var i=new GLatLngBounds(I,p);D=new GGroundOverlay(E.overlay.image,i);F="overlay";H=i.getCenter()}}}return{placemark:D,type:F,point:H}};var z=[],u=[],b=null,h="",v=null,x;if("placemarks" in B){u=B.placemarks}else{var q=["point","polyline","polygon","overlay"];for(x=0;x<q.length;x++){if(q[x] in B){b={};b[q[x]]=B[q[x]];u.push(b)}}}if(u){for(x=0;x<u.length;x++){var s=t(u[x]);v=v||s.point;h=h||s.type;z.push(s.placemark)}}if(z.length>1){h="array"}j.title=C;j.type=h||"none";j.theme=A;if(j.infoPoint){j.infoPoint=new GLatLng(parseFloat(j.infoPoint.lat),parseFloat(j.infoPoint.lon))}else{j.infoPoint=v}var y=new TimeMapItem(z,w,this,j);if(w!==null){w.item=y;this.eventSource.add(w)}if(z.length>0){for(x=0;x<z.length;x++){z[x].item=y;GEvent.addListener(z[x],"click",function(){y.openInfoWindow()});g.map.addOverlay(z[x]);z[x].hide()}}this.items.push(y);return y};function TimeMapDatasetTheme(b){b=b||{};if(!b.icon){var a=new GIcon(G_DEFAULT_ICON);this.iconImage=b.iconImage||GIP+"red-dot.png";a.image=this.iconImage;a.iconSize=new GSize(32,32);a.shadow=GIP+"msmarker.shadow.png";a.shadowSize=new GSize(59,32);a.iconAnchor=new GPoint(16,33);a.infoWindowAnchor=new GPoint(18,3)}this.icon=b.icon||a;this.color=b.color||"#FE766A";this.lineColor=b.lineColor||this.color;this.polygonLineColor=b.polygonLineColor||this.lineColor;this.lineOpacity=b.lineOpacity||1;this.polgonLineOpacity=b.polgonLineOpacity||this.lineOpacity;this.lineWeight=b.lineWeight||2;this.polygonLineWeight=b.polygonLineWeight||this.lineWeight;this.fillColor=b.fillColor||this.color;this.fillOpacity=b.fillOpacity||0.25;this.eventColor=b.eventColor||this.color;this.eventTextColor=b.eventTextColor||null;this.eventIconPath=b.eventIconPath||"timemap/images/";this.eventIconImage=b.eventIconImage||"red-circle.png";this.eventIcon=b.eventIcon||this.eventIconPath+this.eventIconImage;this.classicTape=("classicTape" in b)?b.classicTape:false}TimeMapDataset.redTheme=function(a){return new TimeMapDatasetTheme(a)};TimeMapDataset.blueTheme=function(a){a=a||{};a.iconImage=GIP+"blue-dot.png";a.color="#5A7ACF";a.eventIconImage="blue-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.greenTheme=function(a){a=a||{};a.iconImage=GIP+"green-dot.png";a.color="#19CF54";a.eventIconImage="green-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.ltblueTheme=function(a){a=a||{};a.iconImage=GIP+"ltblue-dot.png";a.color="#5ACFCF";a.eventIconImage="ltblue-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.purpleTheme=function(a){a=a||{};a.iconImage=GIP+"purple-dot.png";a.color="#8E67FD";a.eventIconImage="purple-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.orangeTheme=function(a){a=a||{};a.iconImage=GIP+"orange-dot.png";a.color="#FF9900";a.eventIconImage="orange-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.yellowTheme=function(a){a=a||{};a.iconImage=GIP+"yellow-dot.png";a.color="#ECE64A";a.eventIconImage="yellow-circle.png";return new TimeMapDatasetTheme(a)};TimeMapDataset.themes={red:TimeMapDataset.redTheme(),blue:TimeMapDataset.blueTheme(),green:TimeMapDataset.greenTheme(),ltblue:TimeMapDataset.ltblueTheme(),orange:TimeMapDataset.orangeTheme(),yellow:TimeMapDataset.yellowTheme(),purple:TimeMapDataset.purpleTheme()};function TimeMapItem(b,c,e,a){this.event=c;this.dataset=e;this.map=e.timemap.map;if(b&&TimeMap.isArray(b)&&b.length===0){b=null}if(b&&b.length==1){b=b[0]}this.placemark=b;this.opts=a||{};this.opts.type=a.type||"";this.opts.title=a.title||"";this.opts.description=a.description||"";this.opts.infoPoint=a.infoPoint||null;this.opts.infoHtml=a.infoHtml||"";this.opts.infoUrl=a.infoUrl||"";this.getType=function(){return this.opts.type};this.getTitle=function(){return this.opts.title};this.getInfoPoint=function(){return this.opts.infoPoint||this.map.getCenter()};this.visible=true;this.placemarkVisible=false;this.eventVisible=true;this.openInfoWindow=a.openInfoWindow||e.opts.openInfoWindow||e.timemap.opts.openInfoWindow||false;if(!this.openInfoWindow){if(this.opts.infoUrl!==""){this.openInfoWindow=TimeMapItem.openInfoWindowAjax}else{this.openInfoWindow=TimeMapItem.openInfoWindowBasic}}this.closeInfoWindow=a.closeInfoWindow||e.opts.closeInfoWindow||e.timemap.opts.closeInfoWindow||TimeMapItem.closeInfoWindowBasic}TimeMapItem.prototype.showPlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){this.placemark[a].show()}}else{this.placemark.show()}this.placemarkVisible=true}};TimeMapItem.prototype.hidePlacemark=function(){if(this.placemark){if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){this.placemark[a].hide()}}else{this.placemark.hide()}this.placemarkVisible=false}this.closeInfoWindow()};TimeMapItem.prototype.showEvent=function(){if(this.event){if(this.eventVisible===false){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.add(this.event)}this.eventVisible=true}};TimeMapItem.prototype.hideEvent=function(){if(this.event){if(this.eventVisible==true){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.remove(this.event)}this.eventVisible=false}};TimeMapItem.openInfoWindowBasic=function(){var a=this.opts.infoHtml;if(a===""){a='<div class="infotitle">'+this.opts.title+"</div>";if(this.opts.description!==""){a+='<div class="infodescription">'+this.opts.description+"</div>"}}if(this.placemark&&!this.visible&&this.event){var b=this.dataset.timemap.timeline.getBand(0);b.setCenterVisibleDate(this.event.getStart())}if(this.getType()=="marker"){this.placemark.openInfoWindowHtml(a)}else{this.map.openInfoWindowHtml(this.getInfoPoint(),a)}this.selected=true};TimeMapItem.openInfoWindowAjax=function(){if(this.opts.infoHtml!==""){this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}else{if(this.opts.infoUrl!==""){var a=this;GDownloadUrl(this.opts.infoUrl,function(b){a.opts.infoHtml=b;a.openInfoWindow()})}else{this.openInfoWindow=TimeMapItem.openInfoWindowBasic;this.openInfoWindow()}}};TimeMapItem.closeInfoWindowBasic=function(){if(this.getType()=="marker"){this.placemark.closeInfoWindow()}else{var a=this.map.getInfoWindow();if(a.getPoint()==this.getInfoPoint()&&!a.isHidden()){this.map.closeInfoWindow()}}this.selected=false};TimeMap.trim=function(a){a=a&&String(a)||"";return a.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};TimeMap.isArray=function(a){return a&&!(a.propertyIsEnumerable("length"))&&typeof a==="object"&&typeof a.length==="number"};TimeMap.getTagValue=function(f,a,c){var e="";var b=TimeMap.getNodeList(f,a,c);if(b.length>0){f=b[0].firstChild;while(f!==null){e+=f.nodeValue;f=f.nextSibling}}return e};TimeMap.nsMap={};TimeMap.getNodeList=function(c,a,b){if(b===undefined){return c.getElementsByTagName(a)}if(c.getElementsByTagNameNS&&TimeMap.nsMap[b]){return c.getElementsByTagNameNS(TimeMap.nsMap[b],a)}return c.getElementsByTagName(b+":"+a)};TimeMap.makePoint=function(b,c){var a=null;if(b.lat&&b.lng){a=[b.lat(),b.lng()]}if(TimeMap.isArray(b)){a=b}if(a===null){b=TimeMap.trim(b);if(b.indexOf(",")>-1){a=b.split(",")}else{a=b.split(/[\r\n\f ]+/)}}if(a.length>2){a=a.slice(0,2)}if(c){a.reverse()}return{lat:TimeMap.trim(a[0]),lon:TimeMap.trim(a[1])}};TimeMap.makePoly=function(e,g){var c=[],b;var f=TimeMap.trim(e).split(/[\r\n\f ]+/);if(f.length==0){return[]}for(var a=0;a<f.length;a++){b=(f[a].indexOf(","))?b=f[a].split(","):b=[f[a],f[++a]];if(b.length>2){b=b.slice(0,2)}if(g){b.reverse()}c.push({lat:b[0],lon:b[1]})}return c};TimeMap.formatDate=function(h,g){g=g||3;var i="";if(h){if(h.toISOString){return h.toISOString()}var a=function(l){return((l<10)?"0":"")+l};var f=h.getUTCFullYear(),b=h.getUTCMonth(),j=h.getUTCDate();i+=f+"-"+a(b+1)+"-"+a(j);if(g>1){var c=h.getUTCHours(),e=h.getUTCMinutes(),k=h.getUTCSeconds();i+="T"+a(c)+":"+a(e);if(g>2){i+=a(k)}i+="Z"}}return i};TimeMap.TimelineVersion=function(){if(Timeline.version){return Timeline.version}if(Timeline.DurationEventPainter){return"1.2"}else{return"2.2.0"}};if(!this.JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];if(typeof c==="string"){return c}return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(typeof value.length==="number"&&!value.propertyIsEnumerable("length")){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}})();TimeMap.prototype.toJSON=function(){var a={options:this.makeOptionData,datasets:this.datasets};a=this.addExportData(a);return a};TimeMap.prototype.makeOptionData=function(){var f={};for(var d in this.opts){f[d]=this.opts[d]}if(f.mapCenter){f.mapCenter=TimeMap.makePoint(f.mapCenter)}if(f.mapType){f.mapType=revHash(TimeMap.mapTypes,f.mapType)}if(f.mapTypes){var h=[],c;for(var b=0;b<f.mapTypes.length;b++){c=revHash(TimeMap.mapTypes,f.mapTypes[b]);if(c){h.push(c)}}f.mapTypes=h}if(f.bandIntervals){f.bandIntervals=revHash(TimeMap.intervals,f.bandIntervals)}var a=[],e,g;for(g in this.datasets){if(this.datasets.hasOwnProperty(g)){e=revHash(TimeMapDataset.themes,this.datasets[g].opts.theme);if(e){a.push(e)}}}f.themes=e;return f};TimeMap.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};TimeMapDataset.prototype.toJSON=function(){var a={title:this.getTitle(),theme:revHash(TimeMapDataset.themes,this.opts.theme),data:{type:"basic",value:this.getItems()}};a=this.addExportData(a);return a};TimeMapDataset.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};TimeMapItem.prototype.toJSON=function(){var c={title:this.getTitle(),options:{description:this.opts.description}};if(this.event){c.start=this.event.getStart();if(!this.event.isInstant()){c.end=this.event.getEnd()}}if(this.placemark){var b=function(g,f,h){g=g||TimeMapItem.getPlacemarkType(f);switch(g){case"marker":h.point=TimeMap.makePoint(f.getLatLng());break;case"polyline":case"polygon":var e=[];for(var d=0;d<f.getVertexCount();d++){e.push(TimeMap.makePoint(f.getVertex(d)))}h[g]=e;break}return h};if(this.getType()=="array"){c.placemarks=[];for(var a=0;a<this.placemark.length;a++){c.placemarks.push(b(false,this.placemark[a],{}))}}else{c=b(this.getType(),this.placemark,c)}}c=this.addExportData(c);return c};TimeMapItem.prototype.addExportData=function(a){a.options=a.options||{};a.options.saveOpts=this.opts.saveOpts;return a};function revHash(b,c){for(var a in b){if(b[a]==c){return a}}return null};TimeMap.prototype.clear=function(){this.each(function(a){a.clear()});this.datasets=[]};TimeMap.prototype.deleteDataset=function(a){this.datasets[a].clear();delete this.datasets[a]};TimeMap.prototype.hideDataset=function(a){if(a in this.datasets){this.datasets[a].hide()}};TimeMap.prototype.hideDatasets=function(){this.each(function(a){a.visible=false});this.filter("map");this.filter("timeline");this.timeline.layout()};TimeMap.prototype.showDataset=function(a){if(a in this.datasets){this.datasets[a].show()}};TimeMap.prototype.showDatasets=function(){this.each(function(a){a.visible=true});this.filter("map");this.filter("timeline");this.timeline.layout()};TimeMap.prototype.changeMapType=function(a){if(a==this.opts.mapType){return}if(typeof(a)=="string"){a=TimeMap.mapTypes[a]}if(!a){return}this.opts.mapType=a;this.map.setMapType(a)};TimeMap.prototype.refreshTimeline=function(){var b=this.timeline.getBand(0);var a=b.getCenterVisibleDate();if(TimeMap.TimelineVersion()=="1.2"){b.getEventPainter().getLayout()._laidout=false}this.timeline.layout();b.setCenterVisibleDate(a)};TimeMap.prototype.changeTimeIntervals=function(c){if(c==this.opts.bandIntervals){return}if(typeof(c)=="string"){c=TimeMap.intervals[c]}if(!c){return}this.opts.bandIntervals=c;var d=function(g,f){g.getEther()._interval=Timeline.DateTime.gregorianUnitLengths[f];g.getEtherPainter()._unit=f};var e=this.timeline.getBand(0);var b=e.getCenterVisibleDate();for(var a=0;a<this.timeline.getBandCount();a++){d(this.timeline.getBand(a),c[a])}e.getEventPainter().getLayout()._laidout=false;this.timeline.layout();e.setCenterVisibleDate(b)};TimeMap.prototype.scrollTimeline=function(b){var d=this.timeline.getBand(0);var a=d.getCenterVisibleDate();var c=a.getFullYear()+parseFloat(b);a.setFullYear(c);d.setCenterVisibleDate(a)};TimeMapDataset.prototype.clear=function(){this.each(function(a){a.clear()});this.items=[];this.timemap.timeline.layout()};TimeMapDataset.prototype.deleteItem=function(b){for(var a=0;a<this.items.length;a++){if(this.items[a]==b){b.clear();this.items.splice(a,1);break}}this.timemap.timeline.layout()};TimeMapDataset.prototype.show=function(){if(!this.visible){this.visible=true;this.timemap.filter("map");this.timemap.filter("timeline");this.timemap.timeline.layout()}};TimeMapDataset.prototype.hide=function(){if(this.visible){this.visible=false;this.timemap.filter("map");this.timemap.filter("timeline");this.timemap.timeline.layout()}};TimeMapDataset.prototype.changeTheme=function(a){this.opts.theme=a;this.each(function(b){b.changeTheme(a)});this.timemap.timeline.layout()};TimeMapItem.prototype.show=function(){this.showEvent();this.showPlacemark();this.visible=true};TimeMapItem.prototype.hide=function(){this.hideEvent();this.hidePlacemark();this.visible=false};TimeMapItem.prototype.clear=function(){if(this.event){this.dataset.timemap.timeline.getBand(0).getEventSource()._events._events.remove(this.event)}if(this.placemark){this.hidePlacemark();var b=function(d){try{this.map.removeOverlay(d)}catch(c){}};if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){b(this.placemark[a])}}else{b(this.placemark)}}this.event=this.placemark=null};TimeMapItem.prototype.createEvent=function(c,f){var a=(f===undefined);var b=this.opts.theme.eventIcon;var g=this.getTitle();var d=new Timeline.DefaultEventSource.Event(c,f,null,null,a,g,null,null,null,this.opts.theme.eventIcon,this.opts.theme.eventColor,null);d.item=this;this.event=d;this.dataset.eventSource.add(d)};TimeMapItem.prototype.changeTheme=function(c){this.opts.theme=c;if(this.placemark){var b=function(d,e,f){e=e||TimeMapItem.getPlacemarkType(d);switch(e){case"marker":d.setImage(f.icon.image);break;case"polygon":d.setFillStyle({color:c.fillColor,opacity:c.fillOpacity});case"polyline":d.setStrokeStyle({color:c.lineColor,weight:c.lineWeight,opacity:c.lineOpacity});break}};if(this.getType()=="array"){for(var a=0;a<this.placemark.length;a++){b(this.placemark[a],false,c)}}else{b(this.placemark,this.getType(),c)}}if(this.event){this.event._color=c.eventColor;this.event._icon=c.eventIcon}};TimeMapItem.getPlacemarkType=function(a){if("getIcon" in a){return"marker"}if("getVertex" in a){return"setFillStyle" in a?"polygon":"polyline"}return false};TimeMapItem.prototype.getNext=function(a){if(!this.event){return}var d=this.dataset.timemap.timeline.getBand(0).getEventSource();var b=d.getEventIterator(this.event.getStart(),new Date(d.getLatestDate().getTime()+1));var c=null;while(c===null){if(b.hasNext()){c=b.next().item;if(a&&c.dataset!=this.dataset){c=null}}else{break}}return c};TimeMap.loaders.flickr=function(b){var a=new TimeMap.loaders.jsonp(b);a.preload=function(c){return c.items};a.transform=function(d){var c={title:d.title,start:d.date_taken,point:{lat:d.latitude,lon:d.longitude},options:{description:d.description.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"')}};if(b.transformFunction){c=b.transformFunction(c)}return c};return a};TimeMap.loaders.georss=function(b){var a=new TimeMap.loaders.remote(b);a.parse=TimeMap.loaders.georss.parse;return a};TimeMap.loaders.georss.parse=function(j){var f=[],u,h,c,o;h=GXml.parse(j);var b=TimeMap.getTagValue,p=TimeMap.getNodeList,m=TimeMap.makePoint,a=TimeMap.makePoly;TimeMap.nsMap.georss="http://www.georss.org/georss";TimeMap.nsMap.gml="http://www.opengis.net/gml";TimeMap.nsMap.geo="http://www.w3.org/2003/01/geo/wgs84_pos#";TimeMap.nsMap.kml="http://www.opengis.net/kml/2.2";var r=(h.firstChild.tagName=="rss")?"rss":"atom";var n=(r=="rss"?"item":"entry");c=p(h,n);for(var l=0;l<c.length;l++){o=c[l];u={options:{}};u.title=b(o,"title");n=(r=="rss"?"description":"summary");u.options.description=b(o,n);var s=p(o,"TimeStamp","kml");if(s.length>0){u.start=b(s[0],"when","kml")}if(!u.start){s=p(o,"TimeSpan","kml");if(s.length>0){u.start=b(s[0],"begin","kml");u.end=b(s[0],"end","kml")||TimeMap.formatDate(new Date())}}if(!u.start){if(r=="rss"){var q=new Date(Date.parse(b(o,"pubDate")));u.start=TimeMap.formatDate(q)}else{u.start=b(o,"updated")}}PLACEMARK:{var k,t,e,g;k=b(o,"point","georss");if(k){u.point=m(k);break PLACEMARK}var s=p(o,"Point","gml");if(s.length>0){k=b(s[0],"pos","gml");if(!k){k=b(s[0],"coordinates","gml")}if(k){u.point=m(k);break PLACEMARK}}if(b(o,"lat","geo")){k=[b(o,"lat","geo"),b(o,"long","geo")];u.point=m(k);break PLACEMARK}k=b(o,"line","georss");if(k){u.polyline=a(k);break PLACEMARK}k=b(o,"polygon","georss");if(k){u.polygon=a(k);break PLACEMARK}s=p(o,"LineString");if(s.length>0){g="polyline"}else{s=p(o,"Polygon");if(s.length>0){g="polygon"}}if(s.length>0){k=b(s[0],"posList","gml");if(!k){k=b(s[0],"coordinates","gml")}if(k){u[g]=a(k);break PLACEMARK}}}f.push(u)}h=null;c=null;o=null;s=null;return f};TimeMap.loaders.gss=function(b){var a=new TimeMap.loaders.jsonp(b);if(!a.url){a.url="http://spreadsheets.google.com/feeds/list/"+b.key+"/1/public/values?alt=json-in-script&callback="}a.map=b.map;a.preload=function(c){return c.feed["entry"]};a.transform=function(f){var d=a.map||TimeMap.loaders.gss.map;var c=function(g){if(g in d&&d[g]){return f["gsx$"+d[g]]["$t"]}else{return false}};var e={title:c("title"),start:c("start"),point:{lat:c("lat"),lon:c("lon")},options:{description:c("description")}};if(b.transformFunction){e=b.transformFunction(e)}return e};return a};TimeMap.loaders.gss.map={title:"title",description:"description",start:"start",end:"end",lat:"lat",lon:"lon"};TimeMap.loaders.jsonp=function(a){TimeMap.loaders.mixin(this,a);this.url=a.url};TimeMap.loaders.jsonp.prototype.load=function(b,c){var a=this;TimeMap.loaders.jsonp.read(this.url,function(d){items=a.preload(d);b.loadItems(items,a.transform);c()})};TimeMap.loaders.jsonp.counter=0;TimeMap.loaders.jsonp.read=function(b,c){var d="_"+TimeMap.loaders.jsonp.counter++;TimeMap.loaders.jsonp[d]=function(e){c(e);delete TimeMap.loaders.jsonp[d]};var a=document.createElement("script");a.src=b+"TimeMap.loaders.jsonp."+d;document.body.appendChild(a)};TimeMap.loaders.json_string=function(b){var a=new TimeMap.loaders.remote(b);a.parse=JSON.parse;return a};TimeMap.loaders.json=TimeMap.loaders.jsonp;TimeMap.loaders.kml=function(b){var a=new TimeMap.loaders.remote(b);a.parse=TimeMap.loaders.kml.parse;return a};TimeMap.loaders.kml.parse=function(m){var l=[],g,c,n,b,h,e;c=GXml.parse(m);var f=TimeMap.getTagValue,p=TimeMap.getNodeList;var r=function(u,t){var i=false;var s=p(u,"TimeStamp");if(s.length>0){t.start=f(s[0],"when");i=true}else{s=p(u,"TimeSpan");if(s.length>0){t.start=f(s[0],"begin");t.end=f(s[0],"end")||TimeMap.formatDate(new Date());i=true}}if(!i){var j=u.parentNode;if(j.nodeName=="Folder"||j.nodeName=="Document"){r(j,t)}j=null}};n=p(c,"Placemark");for(h=0;h<n.length;h++){b=n[h];g={options:{}};g.title=f(b,"name");g.options.description=f(b,"description");r(b,g);var d,o,q,k,a;g.placemarks=[];d=p(b,"Point");for(e=0;e<d.length;e++){a={point:{}};o=f(d[e],"coordinates");a.point=TimeMap.makePoint(o,1);g.placemarks.push(a)}d=p(b,"LineString");for(e=0;e<d.length;e++){a={polyline:[]};o=f(d[e],"coordinates");a.polyline=TimeMap.makePoly(o,1);g.placemarks.push(a)}d=p(b,"Polygon");for(e=0;e<d.length;e++){a={polygon:[]};o=f(d[e],"coordinates");a.polygon=TimeMap.makePoly(o,1);g.placemarks.push(a)}l.push(g)}n=p(c,"GroundOverlay");for(h=0;h<n.length;h++){b=n[h];g={options:{},overlay:{}};g.title=f(b,"name");g.options.description=f(b,"description");r(b,g);d=p(b,"Icon");g.overlay.image=f(d[0],"href");d=p(b,"LatLonBox");g.overlay.north=f(d[0],"north");g.overlay.south=f(d[0],"south");g.overlay.east=f(d[0],"east");g.overlay.west=f(d[0],"west");l.push(g)}c=null;n=null;b=null;d=null;return l};TimeMap.loaders.metaweb=function(b){var a=new TimeMap.loaders.jsonp(b);a.HOST=b.host||"http://www.freebase.com";a.QUERY_SERVICE=b.service||"/api/service/mqlread";a.preload=function(g){var h=g.qname;if(h.code.indexOf("/api/status/ok")!=0){var f=h.messages[0];return[]}var e=h.result;return e};var d=b.query||{};var c=encodeURIComponent(JSON.stringify({qname:{query:d}}));a.url=a.HOST+a.QUERY_SERVICE+"?queries="+c+"&callback=";return a};